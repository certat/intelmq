#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""

"""
import argparse
import csv
import io
import json
import requests


URL = 'https://raw.githubusercontent.com/certtools/malware_name_mapping/master/mapping.csv'


def main(url: str=URL):
    download = requests.get(url)
    download.raise_for_status()
    rules = [{"rulename": "%s-%s" % (line[1], abs(hash(line[0]))),
              "if": {"malware.name": line[0]},
              "then": {"classification.identifier": line[1], }}
             for line in csv.reader(io.StringIO(download.text))]
    return json.dumps(rules, indent=4, separators=(',', ': '))


if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        prog='download_mapping',
        description='Downloads malware family mapping and converts it to modify syntax.',
    )

    parser.add_argument('filename', nargs='?',
                        help='The filename to write the converted mapping to. If not given, printed to stdout.')
    parser.add_argument('--url', '-u',
                        default=URL,
                        help='The URL to download the mapping from.')
    args = parser.parse_args()

    if args.filename:
        try:
            with open(args.filename, 'wt') as output:
                output.write(main(url=args.url))
        except PermissionError:
            print('Could not write to file %r.' % args.filename, file=sys.stderr)
            exit(1)
    else:
        print(main(url=args.url))
